{% extends "base.html" %}

{% block title %}Analytics Insights - NextProperty AI{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .insights-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    .insights-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .feature-bar {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 25px;
        border-radius: 12px;
        margin: 8px 0;
        display: flex;
        align-items: center;
        color: white;
        font-weight: 500;
        padding: 0 12px;
        font-size: 0.9rem;
    }
    .price-metric {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 1rem;
    }
    .location-card {
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    .location-card:hover {
        border-left-color: #764ba2;
        background-color: #f8f9fa;
    }
    .back-nav {
        background: rgba(102, 126, 234, 0.1);
        border: none;
        border-radius: 10px;
        padding: 8px 16px;
        color: #667eea;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    .back-nav:hover {
        background: rgba(102, 126, 234, 0.2);
        color: #764ba2;
        text-decoration: none;
    }
    .section-header {
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        margin-bottom: 2rem;
    }
    .error-state {
        background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
    }
    .feature-category-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .progress-animated {
        transition: width 0.6s ease;
    }
    .chart-controls {
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        padding: 10px;
        margin-top: 15px;
    }
    .insight-box {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid #667eea;
    }
    .category-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    .category-legend-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
    }
    .category-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        margin-right: 6px;
    }
    .modal-xl {
        max-width: 95%;
    }
    @media (max-width: 768px) {
        .chart-container {
            height: 300px;
        }
        .modal-xl {
            max-width: 100%;
            margin: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('dashboard.analytics') }}" class="back-nav me-3">
                        <i class="fas fa-arrow-left"></i> Back to Analytics
                    </a>
                    <h1 class="h3 mb-1 d-inline"><i class="fas fa-brain text-primary"></i> {{ page_title or 'Analytics Insights' }}</h1>
                    <p class="text-muted mb-0">Deep dive into feature importance and geographic price analysis</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="exportCharts()">
                        <i class="fas fa-download"></i> Export Charts
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="row">
        <div class="col-12">
            <div class="error-state">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h4>Insights Temporarily Unavailable</h4>
                <p class="mb-3">{{ error_message or 'We are experiencing technical difficulties. Please try again later.' }}</p>
                <a href="{{ url_for('dashboard.analytics') }}" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Return to Analytics
                </a>
            </div>
        </div>
    </div>
    {% else %}

    <!-- Feature Importance Analysis -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="section-header">
                <i class="fas fa-microscope text-primary"></i> ML Model Feature Importance Analysis (26 Features)
            </h2>
        </div>
        
        {% if feature_analysis and feature_analysis.success %}
        <!-- Main Feature Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar text-success"></i> Top 15 Features Influencing Property Prices
                    </h5>
                    <small class="text-muted">Model: {{ feature_analysis.model_type }} | Total Features: {{ feature_analysis.total_features }}</small>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="featureChart"></canvas>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="showAllFeatures()">
                            <i class="fas fa-expand"></i> Show All 26 Features
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showCategoryChart()">
                            <i class="fas fa-layer-group"></i> View by Category
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="debugCharts()">
                            <i class="fas fa-bug"></i> Debug
                        </button>
                    </div>
                    <!-- Debug info -->
                    <div id="debugInfo" style="display: none;" class="mt-3">
                        <h6>Debug Information:</h6>
                        <pre id="debugData"></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Feature Rankings and Categories -->
        <div class="col-lg-4 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-ranking-star text-warning"></i> Top 10 Feature Rankings
                    </h5>
                </div>
                <div class="card-body">
                    {% for feature in feature_analysis.top_10_features %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="fw-medium">{{ loop.index }}. {{ feature.feature }}</span>
                            <br><small class="text-muted">{{ feature.category }}</small>
                        </div>
                        <span class="badge bg-primary">{{ feature.importance_percent|round(2) }}%</span>
                    </div>
                    {% endfor %}
                    
                    <hr class="my-3">
                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#allFeaturesModal">
                            <i class="fas fa-list"></i> View All 26 Features
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Importance Chart -->
        <div class="col-lg-6 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group text-info"></i> Feature Category Importance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Category Breakdown -->
        <div class="col-lg-6 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-purple"></i> Category Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    {% for category in feature_analysis.category_importance %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong>{{ category.category }}</strong>
                            <span class="badge bg-info">{{ category.importance_percent|round(1) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-gradient" 
                                 style="width: {{ category.importance_percent|round(1) }}%; 
                                        background: linear-gradient(90deg, #667eea {{ category.importance_percent|round(1) }}%, #764ba2 100%);"></div>
                        </div>
                        <small class="text-muted">
                            {% set category_features = [] %}
                            {% for feature in feature_analysis.all_features %}
                                {% if feature.category == category.category %}
                                    {% set _ = category_features.append(feature.feature) %}
                                {% endif %}
                            {% endfor %}
                            {{ category_features|length }} features: {{ category_features[:3]|join(', ') }}{% if category_features|length > 3 %}...{% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                Feature analysis is not available. This might be due to model loading issues or insufficient data.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Geographic Price Analysis -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="section-header">
                <i class="fas fa-map-marked-alt text-primary"></i> Geographic Price Analysis
            </h2>
        </div>
        
        {% if price_analytics and price_analytics.success %}
        <!-- Summary Metrics -->
        <div class="col-12 mb-4">
            <div class="row">
                <div class="col-md-3">
                    <div class="price-metric">
                        <h4>{{ price_analytics.summary.total_cities }}</h4>
                        <p class="mb-0">Cities Analyzed</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="price-metric">
                        <h4>{{ price_analytics.summary.total_provinces }}</h4>
                        <p class="mb-0">Provinces</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="price-metric">
                        <h4>{{ price_analytics.summary.total_zones }}</h4>
                        <p class="mb-0">Postal Zones</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="price-metric">
                        <h4>{{ price_analytics.summary.total_property_types }}</h4>
                        <p class="mb-0">Property Types</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="col-lg-6 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-city text-info"></i> Average Prices by Major Cities
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="cityPriceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-home text-success"></i> Average Prices by Property Type
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="propertyTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-flag text-warning"></i> Average Prices by Province
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="provinceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card insights-card h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-map-pin text-danger"></i> Average Prices by Postal Zone
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="zoneChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Tables -->
        <div class="col-12">
            <div class="card insights-card">
                <div class="card-header bg-transparent">
                    <ul class="nav nav-tabs card-header-tabs" id="priceDetailTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="cities-detail-tab" data-bs-toggle="tab" data-bs-target="#cities-detail" type="button" role="tab">
                                Cities
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="provinces-detail-tab" data-bs-toggle="tab" data-bs-target="#provinces-detail" type="button" role="tab">
                                Provinces
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="types-detail-tab" data-bs-toggle="tab" data-bs-target="#types-detail" type="button" role="tab">
                                Property Types
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="zones-detail-tab" data-bs-toggle="tab" data-bs-target="#zones-detail" type="button" role="tab">
                                Postal Zones
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="priceDetailContent">
                        <div class="tab-pane fade show active" id="cities-detail" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>City</th>
                                            <th>Average Price</th>
                                            <th>Properties</th>
                                            <th>Price Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for city in price_analytics.data.cities[:15] %}
                                        <tr class="location-card">
                                            <td><strong>{{ city.name }}</strong></td>
                                            <td>${{ city.avg_price|format_large_number }}</td>
                                            <td>{{ city.property_count }}</td>
                                            <td class="text-muted">${{ city.min_price|format_large_number }} - ${{ city.max_price|format_large_number }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="provinces-detail" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Province</th>
                                            <th>Average Price</th>
                                            <th>Properties</th>
                                            <th>Price Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for province in price_analytics.data.provinces %}
                                        <tr class="location-card">
                                            <td><strong>{{ province.name }}</strong></td>
                                            <td>${{ province.avg_price|format_large_number }}</td>
                                            <td>{{ province.property_count }}</td>
                                            <td class="text-muted">${{ province.min_price|format_large_number }} - ${{ province.max_price|format_large_number }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="types-detail" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Property Type</th>
                                            <th>Average Price</th>
                                            <th>Properties</th>
                                            <th>Price Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for type in price_analytics.data.property_types %}
                                        <tr class="location-card">
                                            <td><strong>{{ type.name }}</strong></td>
                                            <td>${{ type.avg_price|format_large_number }}</td>
                                            <td>{{ type.property_count }}</td>
                                            <td class="text-muted">${{ type.min_price|format_large_number }} - ${{ type.max_price|format_large_number }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="zones-detail" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Postal Zone</th>
                                            <th>Average Price</th>
                                            <th>Properties</th>
                                            <th>Price Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for zone in price_analytics.data.zones %}
                                        <tr class="location-card">
                                            <td><strong>{{ zone.name }}</strong></td>
                                            <td>${{ zone.avg_price|format_large_number }}</td>
                                            <td>{{ zone.property_count }}</td>
                                            <td class="text-muted">${{ zone.min_price|format_large_number }} - ${{ zone.max_price|format_large_number }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                Price analytics data is not available. Please try again later.
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- All Features Modal -->
{% if feature_analysis and feature_analysis.success %}
<div class="modal fade" id="allFeaturesModal" tabindex="-1" aria-labelledby="allFeaturesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allFeaturesModalLabel">
                    <i class="fas fa-list"></i> All 26 Features - Complete Importance Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Rank</th>
                                        <th>Feature</th>
                                        <th>Category</th>
                                        <th>Importance Score</th>
                                        <th>Percentage</th>
                                        <th>Visual Impact</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for feature in feature_analysis.all_features %}
                                    <tr>
                                        <td><strong>#{{ feature.rank }}</strong></td>
                                        <td>{{ feature.feature }}</td>
                                        <td>
                                            <span class="badge bg-{{ ['primary', 'success', 'info', 'warning', 'danger', 'secondary'][loop.index0 % 6] }}">
                                                {{ feature.category }}
                                            </span>
                                        </td>
                                        <td><code>{{ feature.importance|round(6) }}</code></td>
                                        <td><strong>{{ feature.importance_percent|round(2) }}%</strong></td>
                                        <td>
                                            <div class="progress" style="height: 8px; width: 80px;">
                                                <div class="progress-bar bg-gradient" 
                                                     style="width: {{ (feature.importance_percent / feature_analysis.all_features[0].importance_percent * 100)|round(1) }}%; 
                                                            background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Key Insights</h6>
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary">Top Predictors:</h6>
                                <ul class="list-unstyled">
                                    {% for feature in feature_analysis.all_features[:5] %}
                                    <li><strong>{{ feature.feature }}</strong> ({{ feature.importance_percent|round(1) }}%)</li>
                                    {% endfor %}
                                </ul>
                                
                                <h6 class="text-success mt-3">Category Distribution:</h6>
                                {% for category in feature_analysis.category_importance %}
                                <div class="mb-2">
                                    <span class="fw-medium">{{ category.category }}</span>
                                    <div class="progress mt-1" style="height: 6px;">
                                        <div class="progress-bar" 
                                             style="width: {{ category.importance_percent|round(1) }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ category.importance_percent|round(1) }}%</small>
                                </div>
                                {% endfor %}
                                
                                <div class="mt-3 p-2 bg-light rounded">
                                    <small>
                                        <strong>Model:</strong> {{ feature_analysis.model_type }}<br>
                                        <strong>Total Features:</strong> {{ feature_analysis.total_features }}<br>
                                        <strong>Analysis:</strong> Feature importance shows how much each input influences property price predictions.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="exportFeatureData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global geographic price data (always available)
{% if price_analytics and price_analytics.success %}
const cityLabels = {{ price_analytics.data.cities[:15] | map(attribute='name') | list | tojson }};
const cityPrices = {{ price_analytics.data.cities[:15] | map(attribute='avg_price') | list | tojson }};
const propertyTypeLabels = {{ price_analytics.data.property_types | map(attribute='name') | list | tojson }};
const propertyTypePrices = {{ price_analytics.data.property_types | map(attribute='avg_price') | list | tojson }};
const provinceLabels = {{ price_analytics.data.provinces | map(attribute='name') | list | tojson }};
const provincePrices = {{ price_analytics.data.provinces | map(attribute='avg_price') | list | tojson }};
const zoneLabels = {{ price_analytics.data.zones | map(attribute='name') | list | tojson }};
const zonePrices = {{ price_analytics.data.zones | map(attribute='avg_price') | list | tojson }};
console.log('Geographic data loaded - Cities:', cityLabels.length, 'Property Types:', propertyTypeLabels.length, 'Provinces:', provinceLabels.length, 'Zones:', zoneLabels.length);
{% else %}
const cityLabels = [];
const cityPrices = [];
const propertyTypeLabels = [];
const propertyTypePrices = [];
const provinceLabels = [];
const provincePrices = [];
const zoneLabels = [];
const zonePrices = [];
console.log('No geographic data available');
{% endif %}

// Price Analytics Charts
let cityChart, propertyTypeChart, provinceChart, zoneChart;

// Geographic Charts Functions
function initGeographicCharts() {
    console.log('Initializing geographic charts...');
    initCityPriceChart();
    initPropertyTypeChart();
    initProvinceChart();
    initZoneChart();
}

// City Price Chart
function initCityPriceChart() {
    const canvas = document.getElementById('cityPriceChart');
    if (!canvas) {
        console.error('City price chart canvas not found');
        return;
    }

    if (cityLabels.length === 0) {
        console.warn('No city data available for chart');
        return;
    }

    const ctx = canvas.getContext('2d');
    cityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: cityLabels,
            datasets: [{
                label: 'Average Price ($)',
                data: cityPrices,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Average Property Prices by City'
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
    console.log('City chart initialized successfully');
}

// Property Type Chart
function initPropertyTypeChart() {
    const canvas = document.getElementById('propertyTypeChart');
    if (!canvas) {
        console.error('Property type chart canvas not found');
        return;
    }

    if (propertyTypeLabels.length === 0) {
        console.warn('No property type data available for chart');
        return;
    }

    const ctx = canvas.getContext('2d');
    propertyTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: propertyTypeLabels,
            datasets: [{
                data: propertyTypePrices,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)',
                    'rgba(83, 102, 255, 0.8)',
                    'rgba(255, 159, 243, 0.8)',
                    'rgba(154, 205, 50, 0.8)',
                    'rgba(255, 69, 0, 0.8)',
                    'rgba(147, 112, 219, 0.8)',
                    'rgba(255, 20, 147, 0.8)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Average Prices by Property Type'
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.parsed.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    console.log('Property type chart initialized successfully');
}

// Province Chart
function initProvinceChart() {
    const canvas = document.getElementById('provinceChart');
    if (!canvas) {
        console.error('Province chart canvas not found');
        return;
    }

    if (provinceLabels.length === 0) {
        console.warn('No province data available for chart');
        return;
    }

    const ctx = canvas.getContext('2d');
    provinceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: provinceLabels,
            datasets: [{
                label: 'Average Price ($)',
                data: provincePrices,
                backgroundColor: 'rgba(255, 205, 86, 0.8)',
                borderColor: 'rgba(255, 205, 86, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Average Property Prices by Province'
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    console.log('Province chart initialized successfully');
}

// Zone Chart
function initZoneChart() {
    const canvas = document.getElementById('zoneChart');
    if (!canvas) {
        console.error('Zone chart canvas not found');
        return;
    }

    if (zoneLabels.length === 0) {
        console.warn('No zone data available for chart');
        return;
    }

    const ctx = canvas.getContext('2d');
    zoneChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: zoneLabels,
            datasets: [{
                label: 'Average Price ($)',
                data: zonePrices,
                backgroundColor: 'rgba(255, 99, 132, 0.8)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Average Property Prices by Postal Zone'
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
    console.log('Zone chart initialized successfully');
}

// Initialize geographic charts when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing geographic charts...');
    setTimeout(() => {
        initGeographicCharts();
    }, 200);
});
</script>

{% if feature_analysis and feature_analysis.success %}
<script>
console.log('Initializing feature importance charts...');

// Prepare feature data from server using safe JSON encoding
const featureLabels = {{ feature_analysis.top_10_features | map(attribute='feature') | list | tojson }};
const featureData = {{ feature_analysis.top_10_features | map(attribute='importance_percent') | list | tojson }};
const allFeatureLabels = {{ feature_analysis.all_features | map(attribute='feature') | list | tojson }};
const allFeatureData = {{ feature_analysis.all_features | map(attribute='importance_percent') | list | tojson }};
const categoryLabels = {{ feature_analysis.category_importance | map(attribute='category') | list | tojson }};
const categoryData = {{ feature_analysis.category_importance | map(attribute='importance_percent') | list | tojson }};

console.log('Data loaded - Features:', featureLabels.length, 'Categories:', categoryLabels.length);

// Global chart variables
let featureChart = null;
let categoryChart = null;
let currentView = 'top10';

// Generate colors
function generateColors(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
        const hue = (i * 137.508) % 360;
        colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
    }
    return colors;
}

// Initialize Feature Chart
function initFeatureChart() {
    const canvas = document.getElementById('featureChart');
    if (!canvas) {
        console.error('Feature chart canvas not found');
        return;
    }

    console.log('Creating feature chart...');
    
    const colors = generateColors(featureLabels.length);

    featureChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: featureLabels.slice(0, 15),
            datasets: [{
                label: 'Importance %',
                data: featureData.slice(0, 15),
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Top 15 Features by Importance',
                    font: { size: 16 }
                },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(2) + '% importance';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        }
                    },
                    title: { display: true, text: 'Importance (%)' }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: { size: 10 }
                    },
                    title: { display: true, text: 'Features' }
                }
            }
        }
    });

    console.log('Feature chart created successfully');
}

// Initialize Category Chart
function initCategoryChart() {
    const canvas = document.getElementById('categoryChart');
    if (!canvas) {
        console.error('Category chart canvas not found');
        return;
    }

    console.log('Creating category chart...');

    const categoryColors = [
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 99, 132, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)'
    ];

    categoryChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: categoryColors,
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Feature Categories by Total Importance'
                },
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });

    console.log('Category chart created successfully');
}

// Show all 26 features
function showAllFeatures() {
    if (!featureChart) return;
    
    console.log('Showing all features...');
    
    const colors = generateColors(allFeatureLabels.length);
    
    featureChart.data.labels = allFeatureLabels;
    featureChart.data.datasets[0].data = allFeatureData;
    featureChart.data.datasets[0].backgroundColor = colors;
    featureChart.data.datasets[0].borderColor = colors.map(c => c.replace('0.8', '1'));
    featureChart.options.plugins.title.text = 'All 26 Features by Importance';
    featureChart.update();
    currentView = 'all26';
}

// Show category chart
function showCategoryChart() {
    if (!featureChart) return;
    
    console.log('Switching to category view...');
    
    featureChart.destroy();
    const canvas = document.getElementById('featureChart');
    
    featureChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: categoryLabels,
            datasets: [{
                label: 'Category Importance %',
                data: categoryData,
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Feature Categories by Total Importance',
                    font: { size: 16 }
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
    
    currentView = 'category';
}

// Export functionality (simplified)
function exportCharts() {
    alert('Export functionality available! Charts can be saved by right-clicking and selecting "Save image as..."');
}

function exportFeatureData() {
    // Simple CSV export
    let csvContent = "Rank,Feature,Category,Importance\n";
    // This would need to be populated from the template data
    alert('CSV export functionality coming soon!');
}

// Debug function
function debugCharts() {
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
        debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        
        const debugData = document.getElementById('debugData');
        if (debugData) {
            const debug = {
                chartsInitialized: {
                    feature: !!featureChart,
                    category: !!categoryChart
                },
                dataLoaded: {
                    features: featureLabels.length,
                    categories: categoryLabels.length
                },
                currentView: currentView
            };
            debugData.textContent = JSON.stringify(debug, null, 2);
        }
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing feature charts...');
    setTimeout(() => {
        initFeatureChart();
        initCategoryChart();
    }, 100);
});
</script>
{% else %}
<script>
console.log('Feature analysis not available');
</script>
{% endif %}

{% endblock %}
